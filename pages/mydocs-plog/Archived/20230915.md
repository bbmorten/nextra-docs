# 20230915 Docker

- Moved to docker-v3 documentation (16.09.2023)
- Can be removed

##  Links

- [Docker - Awesome Compose Samples](https://github.com/docker/awesome-compose)
- [Play with Docker](https://labs.play-with-docker.com)
- [Play with Docker Documentation - GitHUB](https://github.com/play-with-docker/play-with-docker.github.io)
- [Play with Docker - GitHUB](https://github.com/play-with-docker)

### Repo(s)

```shell title="Docker up and running 3rd Edition"
git clone \
    https://github.com/bluewhalebook/docker-up-and-running-3rd-edition.git \
    --config core.autocrlf=input
```

### cAdvisor

cAdvisor (Container Advisor) provides container users an understanding of the resource usage and performance characteristics of their running containers. It is a running daemon that collects, aggregates, processes, and exports information about running containers. Specifically, for each container it keeps resource isolation parameters, historical resource usage, histograms of complete historical resource usage and network statistics. This data is exported by container and machine-wide.

<https://github.com/google/cadvisor/tree/master>

```shell

VERSION=v0.36.0 
docker run \
  --volume=/:/rootfs:ro \
  --volume=/var/run:/var/run:ro \
  --volume=/sys:/sys:ro \
  --volume=/var/lib/docker/:/var/lib/docker:ro \
  --volume=/dev/disk/:/dev/disk:ro \
  --publish=8080:8080 \
  --detach=true \
  --name=cadvisor \
  --privileged \
  --device=/dev/kmsg \
  gcr.io/cadvisor/cadvisor:$VERSION
```

##   Docker Training Notes (Day 5)

###  docker service examples

```shell

docker service create \
    --name node-hostname \
    --replicas 3 \
    -p 8081:80 \
    --env NODE_HOSTNAME="{{.Node.Hostname}}" \
    nginx

```

```shell

docker service create \
    --name node-global \
    —mode global  \
    -p 8082:80 \
    --env NODE_HOSTNAME="{{.Node.Hostname}}" \
    nginx

```

```shell title="Quantum Game"

docker service create --detach=true --name quantum \
    --replicas 2 --publish published=8092,target=8080 --network default-net \
    spkane/quantum-game:latest

docker service scale --detach=false quantum=4

docker service update --update-delay 10s \
    --update-failure-action rollback --update-monitor 5s \
    --update-order start-first --update-parallelism 1 \
    --detach=false \
    --image spkane/quantum-game:latest-plus quantum

docker service rollback quantum
```

### docker network create (overlay driver)

```shell

docker network create --driver=overlay default-net

```

###  docker compose stack example

```shell title="RocketChat"
git clone <https://github.com/spkane/rocketchat-hubot-demo.git> \
    --config core.autocrlf=input

cd rocketchat-hubot-demo/stack

docker stack deploy --compose-file docker-compose-stack.yaml \
    rocketchat

docker stack ls

docker service ls

docker stack ps -f "desired-state=running" rocketchat

docker stack rm rocketchat

docker node ls

docker service ps -f "desired-state=running" quantum

docker service ls
```

### Draining a worker node in Docker Swarm

```shell

docker node update --availability drain worker2

```

### docker -H examples

```shell

docker -H 172.17.4.1 node inspect --pretty ip-172-17-4-3

docker -H 172.17.4.1 node update --availability active ip-172-17-4-3

docker -H 172.17.4.1 service rm quantum

docker -H 172.17.4.1 network rm default-net
```

### nsenter example

docker container run -d --rm  ubuntu:22.04 sleep 600

docker container ls

docker container inspect --format \{{.State.Pid\}} fd521174d66d

docker container top fd

docker container run --rm -it --privileged --pid=host debian \
    nsenter --target 2721 --all

### Using container:<parameter>

```shell
docker container run --rm -d --name outyet-small \
    --publish mode=ingress,published=8090,target=8080 \
    spkane/outyet:1.9.4-small

docker container top outyet-small

docker container exec -it outyet-small /bin/sh

docker container run --rm -it --pid=container:outyet-small \
  --net=container:outyet-small --cap-add sys_ptrace \
  --cap-add sys_admin spkane/train-os /bin/sh
```

### gvisor

```shell

docker container run --rm --runtime=runsc -it alpine /bin/sh



```

### bind, volume mount examples

#### Create volume using vieux/sshfs plugin and use it in a service

```shell
    export STORAGE_SERVER_PRIVATE_IP=192.168.49.94
    export CLOUD_USER=vm
    export PASSWORD=Password1!
    docker volume create --driver vieux/sshfs \
    -o sshcmd=$CLOUD_USER@$STORAGE_SERVER_PRIVATE_IP:/home/$CLOUD_USER/external \
    -o password=$PASSWORD \
    sshvolume
```

```shell
    docker service create -d \
    --replicas=3 \
    --name nginx-web \
    -p 8093:80 \
    --mount volume-driver=vieux/sshfs,source=sshvolume,target=/usr/share/nginx/html,volume-opt=sshcmd=vm@192.168.49.94,volume-opt=password="Password1!" nginx
```

#### Container Image using SSHFS

Last command is failing.

```Dockerfile

RUN apk add --no-cache openssh-client sshfs

# Copy the SSH private key into the container

COPY id_rsa /root/.ssh/id_rsa

# Make sure the key file is secure

RUN chmod 600 /root/.ssh/id_rsa

# Run SSHFS (replace placeholders with your specific details)

RUN sshfs -o StrictHostKeyChecking=no,IdentityFile=/root/.ssh/id_rsa vm@192.168.49.94:/usr/share/nginx/html /usr/share/nginx/html
```

#### Volume mount with docker run

```shell
docker run   --mount type=volume,volume-driver=local,volume-opt=type=nfs,volume-opt=device=:/home/vm/external,volume-opt=o=addr=192.168.49.94,target=/usr/share/nginx/html   -it --rm -p 8094:80 nginx
```

#### Creating an NFS mount on the host and using it for bind mount

- Create the NFS mount

```shell
sudo mount -t nfs -o vers=4 192.168.49.94:/home/vm/external /home/vm/partition1
```

- Use the mounted partition in service creation

```shell
docker service create --name nginx-common  --mode global --mount type=bind,source=/home/vm/partition1,destination=/usr/share/nginx/html -p 8099:80 nginx
```

#### Using an NFS mount in dynamic volume creation with docker service command

```shell
docker service create -d     --name nfs-service-global --mode global     --mount 'type=volume,source=nfsvolume,target=/usr/share/nginx/html,volume-driver=local,volume-opt=type=nfs,volume-opt=device=:/home/vm/external,"volume-opt=o=addr=192.168.49.94,rw,nfsvers=4,async"'     -p 8096:80 nginx:latest
```

#### Creating a volume which uses an NFS mount manually

```shell
docker volume create --driver local \
    --opt type=nfs \
    --opt o=addr=192.168.49.94,ro \
    --opt device=:/home/vm/external \
    manuel-volume-nfs


docker run -it --rm --name webserver1 -v manuel-volume-nfs:/usr/share/nginx/html:ro -d nginx
```

#### Creating a volume which uses an SSHFS mount manually

```shell
docker plugin install vieux/sshfs sshkey.source

docker volume create -d vieux/sshfs -o sshcmd=vm@192.168.49.94:/home/vm/kernel -o password=Password1! sshvolume
sshvolume

docker run -it --rm --name webserver2 -v sshvolume:/usr/share/nginx/html:ro -d nginx
```
